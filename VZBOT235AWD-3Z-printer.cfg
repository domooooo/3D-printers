

#########--PID--##################
##热床PID校正
#PID_CALIBRATE HEATER=heater_bed TARGET=95
##挤出头PID校正
#PID_CALIBRATE HEATER=extruder TARGET=245

[include domo_leds.cfg]
[include mainsail.cfg]
[include testing.cfg]
[include quickdraw.cfg]

[exclude_object]

#########--机器设置--##################
[mcu sht36v2]
canbus_uuid: db72c56d1dcd
#  python3 ~/klipper/lib/canboot/flash_can.py -u db72c56d1dcd


[mcu]
##	Obtain mcu value by "ls -l /dev/serial/by-id/" 
#serial: /dev/ttyAMA0      #uart
#serial: /dev/ttyACM0      #usb
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_29002C001850534E4E303720-if00     #usb
#restart_method: command

[printer]
kinematics: corexy
max_velocity: 500
max_accel: 30000
max_accel_to_decel: 30000
max_z_velocity: 30
max_z_accel: 500
square_corner_velocity: 30

#########--温度显示--##################

#[temperature_sensor mcu]        # 主板温度
#sensor_type: temperature_mcu
#min_temp:0
#max_temp:100

#[temperature_sensor raspberry_pi]    # 树莓派温度
#sensor_type: temperature_host
#min_temp: 0
#max_temp: 100

## SHT36v2温度
[temperature_sensor SHT36v2]
sensor_type: temperature_mcu
sensor_mcu: sht36v2

## SHT36v2板载NTC100K温度
[temperature_sensor Warehouse]
sensor_type = ATC Semitec 104GT-2
sensor_pin = sht36v2:PA4
min_temp: -50
max_temp: 350

## 热床实际温度
[temperature_sensor Bed_Heater]
sensor_type = Generic 3950
sensor_pin = PB0
min_temp: 0
max_temp: 200

#########--共振补偿--##################

##用ADXL345加速度计配置共振补偿
##查询加速器的参数，测试加速度计是否正常工作，输入  ACCELEROMETER_QUERY
##输入自动测试配置命令   SHAPER_CALIBRATE  



[adxl345]
cs_pin: sht36v2:PA9
spi_bus = spi2
# spi_software_sclk_pin: sht36v2:PB13
# spi_software_mosi_pin: sht36v2:PB15
# spi_software_miso_pin: sht36v2:PB14

[resonance_tester]
accel_chip: adxl345
probe_points:
    110,110,30  # 这个地方建议配置成热床的中间

#[input_shaper]            #共振补偿 手动输入时填写
#shaper_freq_x: 85
#shaper_freq_y: 85
#shaper_type: mzv

#########--电机及驱动设置--##################

[stepper_x]    #	Connected to X-MOT  M1
step_pin: PE11
dir_pin: !PE10
enable_pin: !PE9
rotation_distance: 40
microsteps: 16
endstop_pin: ^sht36v2:PA2
position_endstop: 0
position_max: 225
position_min: 0
homing_speed: 100        # Increase after initial setup, Max 100
homing_retract_dist: 5
homing_positive_dir: false
step_pulse_duration: 0.000004

[tmc2209 stepper_x]
uart_pin: PE7
interpolate: true
run_current: 1
#hold_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_x1]    ##	in M3 position
dir_pin: PD13
enable_pin: !PD15
step_pin: PD14
rotation_distance: 40
microsteps: 16
full_steps_per_rotation: 200  
step_pulse_duration: 0.000004

[tmc2209 stepper_x1]
uart_pin: PD10
interpolate: true
run_current: 1
#hold_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_y]            #	Connected to Y-MOT  M2
step_pin: PD8
dir_pin: !PB12
enable_pin: !PD9
rotation_distance: 40
microsteps: 16
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: ^sht36v2:PA1
position_endstop: 215
position_min: 0
position_max: 215
homing_speed: 100        # Increase after initial setup, Max 100
homing_retract_dist: 5
homing_positive_dir: true
step_pulse_duration: 0.000004

[tmc2209 stepper_y]
uart_pin: PE15
interpolate: true
run_current: 1
#hold_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_y1]     ##	in M4 position
dir_pin: PD6
enable_pin: !PD4
step_pin: PD5
rotation_distance: 40
microsteps: 16
full_steps_per_rotation: 200 
step_pulse_duration: 0.000004

[tmc2209 stepper_y1]
uart_pin: PD7
interpolate: true
run_current: 1
#hold_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0


[stepper_z]      ##	in M5 position
step_pin: PE6
dir_pin: PC13
enable_pin: !PE5
rotation_distance: 40
gear_ratio: 20:1
microsteps: 16
full_steps_per_rotation: 200 
#endstop_pin: ^sht36v2:PC15
endstop_pin: probe:z_virtual_endstop
#position_endstop: 0
position_max: 210
position_min: -5
homing_speed: 10
second_homing_speed: 3
homing_retract_dist: 3

[tmc2208 stepper_z]
uart_pin: PC14
#uart_address: 0
interpolate: true
run_current: 0.6
#hold_current: 0.3
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z1]       ##	in M6 position
step_pin: PE2
dir_pin: PE4
enable_pin: !PE3
rotation_distance: 40
gear_ratio: 20:1
microsteps: 16
full_steps_per_rotation: 200

[tmc2208 stepper_z1]
uart_pin: PC15
run_current: 0.6
#hold_current: 0.3
stealthchop_threshold: 0
interpolate: true

[stepper_z2]       ##	in M7 position
step_pin: PD12
dir_pin: !PC4
enable_pin: !PE8
rotation_distance: 40
gear_ratio: 20:1
microsteps: 16
full_steps_per_rotation: 200


[tmc2208 stepper_z2]
uart_pin: PA15
run_current: 0.6
#hold_current: 0.3
stealthchop_threshold: 0
interpolate: true

[extruder]
#step_pin: PD5               # Spider v2.x
#dir_pin: !PD6               # Spider v2.x
#enable_pin: !PD4            # Spider v2.x
step_pin: sht36v2:PB4        # sht36 can
dir_pin: !sht36v2:PB3         # sht36 can
enable_pin: !sht36v2:PA15   # sht36 can
#max_extruder_only_distance: 100   手动默认挤出长度
##	Update value below when you perform extrude r calibration
##	If you ask for 100mm of filament, but in reality it is 98mm:
##	rotation_distance = <previous_rotation_distance> * <actual_extrude_distance> / 100
##  22.6789511 is a good starting point
#rotation_distance: 22.6789511	#Bondtech 5mm Drive Gears
rotation_distance: 22.6119546	#BMG
#gear_ratio: 50:17				#BMG Gear Ratio
gear_ratio: 47:10				#sherpa mini Gear Ratio
microsteps: 16
full_steps_per_rotation: 200	#200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.75
#sensor_type: Generic 3950  
#pullup_resistor: 4700
#heater_pin: PB15      # In E0 OUT Position   Spider v2.x
#sensor_pin: PC0      # TE0 Position      Spider v2.x
heater_pin: sht36v2:PA8      # sht36 can
#sensor_pin: sht36v2:PA3      # sht36 can
max_power: 1
min_extrude_temp: 170
##---- PT100 -----##
sensor_type: MAX31865
sensor_pin: sht36v2:PB12
spi_bus = spi2
# spi_software_sclk_pin: sht36v2:PB13
# spi_software_mosi_pin: sht36v2:PB15
# spi_software_miso_pin: sht36v2:PB14
min_temp: -50
max_temp: 350
rtd_reference_r: 430
##----       -----##
#max_extrude_cross_section: 0.640
#control = pid
#pid_kp = 26.213
#pid_ki = 1.304
#pid_kd = 131.721

##   挤出机压力补偿
# https://realdeuce.github.io/Voron/PA/pressure_advance.html PA校准网址
#SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=1 ACCEL=500            #测试前输入代码
pressure_advance_smooth_time: 0.040      ##	Default is 0.040, leave stock
pressure_advance: 0.04   

[tmc2209 extruder]
#uart_pin: PD7              # Spider v2.x
uart_pin: sht36v2:PB5       # sht36 can
interpolate: true
run_current: 0.7
#hold_current: 0.2
sense_resistor: 0.110
stealthchop_threshold: 0

#[verify_heater extruder]      #防止温度失控  容差50℃ 
#max_error: 120
#check_gain_time:20           
#hysteresis: 50               #距离目标差值多少停止打印
#heating_gain: 2

#########--热床--##################

[heater_bed]
heater_pin: PB4
sensor_type: Generic 3950 # For Keenovo, verify yours
sensor_pin: PB1
smooth_time: 3.0
#max_power: 0.6         # Only need this for 100w pads
min_temp: 0
max_temp: 150
#control: pid            # Do PID calibration
#pid_kp: 68.453
#pid_ki: 2.749
#pid_kd: 426.122

#########--风扇--##################

[heater_fan hotend_fan]    #喉管散热风扇
##	Hotend Fan - FAN0 Connector
#pin: PA13 # Spider v2.x
pin: sht36v2:PB11   #sht36 can
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50         #温度低于此温度风扇关闭
##	If you are experiencing back flow, you can reduce fan_speed
#fan_speed: 1.0         # You can't PWM the delta fan unless using blue wire

[multi_pin domofan]     #多引脚同时控制多个风扇
pins: PB2,PA14,PA13

[fan]         #模型散热风扇
##	Print Cooling Fan - FAN1 Connector
#pin: PA14 # Spider v2.x
pin: sht36v2:PB10  #sht36 can
max_power: 1
kick_start_time: 0.2
##	Depending on your fan, you may need to increase this value
##	if your fan will not start. Can change cycle_time (increase)
##	if your fan is not able to slow down effectively
off_below: 0.10

[heater_fan controller_fan]
##	Controller fan - FAN2 Connector
pin=multi_pin:domofan    #多引脚同时控制多个风扇
max_power: 1
kick_start_time: 0.5
cycle_time: 0.010
heater: extruder
heater_temp: 2

## FAN1  侧吹风扇
#[fan_generic supper_cooling_fan]
#pin=multi_pin:domofan
#max_power: 1.0
#kick_start_time: 0.5
#off_below: 0.10


#########--LED Control--##################



#########----##################

[idle_timeout]
timeout: 1800

#########--调平相关--##################

[manual_probe]


[probe]
pin: ^sht36v2:PC15 
#z_offset: 3.35
x_offset: -25
y_offset: -60
speed: 3.0
samples: 3
samples_result: median 
samples_tolerance_retries: 6


[z_tilt]
z_positions:
	-60, -10
	125, 295
	295, -10
points:
	10, 10
	90, 150
	190, 10
speed: 300
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.02

[homing_override]
axes: z
set_position_z: 0
gcode:
   G90
   G0 Z10 F180
   G28 X 
   G0 X67 F9000
   G28 Y
   G0 X85 Y60 F9000  
   PROBE_OUT
   G28 Z
   G0 Z10 F180     
   PROBE_IN

#########--宏定义--##################

[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customize for your slicer of choice
gcode:    
    G28                            ; home all axes
    PROBE_OUT
    Z_TILT_ADJUST
    G1 Z10 F180                   ; move nozzle away from bed
    PROBE_IN
    PartyTime  
       
[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customize for your slicer of choice
gcode:
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-3.0 F3600                 ; retract filament
    G91                            ; relative positioning
    

    #   Get Boundaries
    {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}
    {% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}

    #   Check end position to determine safe direction to move
    {% if printer.toolhead.position.x < (max_x - 20) %}
        {% set x_safe = 20.0 %}
    {% else %}
        {% set x_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.y < (max_y - 20) %}
        {% set y_safe = 20.0 %}
    {% else %}
        {% set y_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.z < (max_z - 2) %}
        {% set z_safe = 2.0 %}
    {% else %}
        {% set z_safe = max_z - printer.toolhead.position.z %}
    {% endif %}

    G0 Z{z_safe} F3600             ; move nozzle up
    G0 X{x_safe} Y{y_safe} F20000  ; move nozzle to remove stringing
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    G90                            ; absolute positioning
    G0 X110 Y110 F3600          ; park nozzle at rear
    M84 X Y E ;Disable all steppers but Z
    PartyTime
   
	
[gcode_macro LOAD_FILAMENT]
gcode:
   M83                            ; set extruder to relative
   G1 E30 F300                    ; load
   G1 E15 F150                    ; prime nozzle with filament
   M82                            ; set extruder to absolute
    
[gcode_macro UNLOAD_FILAMENT]
gcode:
   M83                            ; set extruder to relative
   G1 E10 F300                    ; extrude a little to soften tip
   G1 E-40 F1800                  ; retract some, but not too much or it will jam
   M82                            ; set extruder to absolute


[display_status]

[virtual_sdcard]
path: /home/pi/gcode_files

[pause_resume]

[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
# change this if you need more or less extrusion
variable_extrude: 1.0
gcode:
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  ##### set park positon for x and y #####
  # default is your max posion from your printer.cfg
  {% set x_park = printer.toolhead.axis_maximum.x|float - 5.0 %}
  {% set y_park = printer.toolhead.axis_maximum.y|float - 5.0 %}
  ##### calculate save lift position #####
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% if act_z < (max_z - 2.0) %}
      {% set z_safe = 2.0 %}
  {% else %}
      {% set z_safe = max_z - act_z %}
  {% endif %}
  ##### end of definitions #####
  PAUSE_BASE
  G91
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G1 E-{E} F2100
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}
  {% if "xyz" in printer.toolhead.homed_axes %}
    G1 Z{z_safe} F900
    G90
    G1 X{x_park} Y{y_park} F6000
  {% else %}
    {action_respond_info("Printer not homed")}
  {% endif %} 


[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  #### get VELOCITY parameter if specified ####
  {% if 'VELOCITY' in params|upper %}
    {% set get_params = ('VELOCITY=' + params.VELOCITY)  %}
  {%else %}
    {% set get_params = "" %}
  {% endif %}
  ##### end of definitions #####
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G91
    G1 E{E} F2100
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}  
  RESUME_BASE {get_params}

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
  TURN_OFF_HEATERS
  CANCEL_PRINT_BASE


# Sensor Types
#   "EPCOS 100K B57560G104F"
#   "ATC Semitec 104GT-2"
#   "NTC 100K beta 3950"更改为 Generic 3950 (Keenovo Heater Pad)
#   "Honeywell 100K 135-104LAG-J01"
#   "NTC 100K MGB18-104F39050L32"
#   "AD595"
#   "PT100 INA826"

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 54.012
#*# pid_ki = 0.311
#*# pid_kd = 2343.449
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 15.445
#*# pid_ki = 0.548
#*# pid_kd = 108.890
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 98.0
#*# shaper_type_y = mzv
#*# shaper_freq_y = 89.2
#*#
#*# [probe]
#*# z_offset = 3.290
